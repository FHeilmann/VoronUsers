name: VoronUsers CI v2
run-name: VoronUsers CI version 2 üöÄ
on:
  pull_request:
    types: [opened, reopened, synchronize]
jobs:
  checkout_check_whitespace:
    name: Checkout & Check whitespace
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Get changed files and check whitespace üîç
        id: changed-files
        uses: FHeilmann/pr-changed-files-check-whitespace@main
      - name: List all changed files üìÉ
        run: |
          echo "::group::changed-files"
          for file in ${{ steps.changed-files.outputs.changed_files }}; do
            echo "Changed file: $file"
          done
          echo "::endgroup::"
      - name: Perform Sparse Checkout üõí
        id: sparse-checkout
        uses: FHeilmann/sparse-checkout@main
        with:
          files: ${{steps.changed-files.outputs.changed_files}}
          folders: ".github/workflows"
          patterns: ""
          path: ${{github.workspace}}
          branch: ${{github.ref}}
      - name: Cache checked out files üß∞
        id: build-repo-cache
        uses: actions/cache@v3
        with:
          path: ${{github.workspace}}
          key: cache-${{github.sha}}
  setup_python:
    name: Prepare python environment
    runs-on: ubuntu-latest
    steps:
      - name: Setup python 3.11 üêç
        id: python311
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Get python package cache üß∞
        uses: actions/cache@v3
        id: cache-python
        env:
          cache-name: cache-python
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}
      - if: ${{ steps.cache-python.outputs.cache-hit != 'true' }}
        name: Install Python packages (cached) üõ†Ô∏è
        run: |
          pip install pykwalify admesh git+https://github.com/ChristophSchranz/Tweaker-3.git
  check_stls:
    name: Validate STLs
    runs-on: ubuntu-latest
    needs: [checkout_check_whitespace, setup_python]
    steps:
      - name: Get repository files üß∞
        uses: actions/cache/restore@v3
        id: get-repo-cache
        with:
          path: ${{github.workspace}}
          key: cache-${{github.sha}}
      - name: Setup python 3.11 üêç
        id: python311
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Get python package cache üß∞
        uses: actions/cache/restore@v3
        id: cache-python
        env:
          cache-name: cache-python
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}
      - name: Install apt packages (cached) üõ†Ô∏è
        uses: awalsh128/cache-apt-pkgs-action@v1.3.0
        with:
          packages: admesh, libadmesh-dev
          version: 1.0
      - name: Show tool versions üèÉ
        id: run-tools
        run: |
          admesh --version
      - name: Check for STL corruption ‚úÖ
        id: check-stls
        run: |
          echo "::group::check-stls"
          chmod +x ${{ github.workspace }}/.github/workflows/validate_stl.py
          for file in $(echo $(find ${{ github.workspace }} -type f -iname '*.STL') | tr '\n' ' '); do
            python3 ${{ github.workspace }}/.github/workflows/validate_stl.py $file || touch failed
          done
          if [ -f "failed" ]; then
            echo "Error occurred while validating STLs."
            exit 255
          fi
          echo "::endgroup::"
  check_stl_rotation:
    name: Check STL rotation
    runs-on: ubuntu-latest
    needs: [checkout_check_whitespace, setup_python]
    steps:
      - name: Get repository files üß∞
        uses: actions/cache/restore@v3
        id: get-repo-cache
        with:
          path: ${{github.workspace}}
          key: cache-${{github.sha}}
      - name: Setup python 3.11 üêç
        id: python311
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Get python package cache üß∞
        uses: actions/cache@v3
        id: cache-python
        env:
          cache-name: cache-python
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}
      - name: Show tool versions üèÉ
        id: run-tools
        run: |
          tweaker3 --version
      - name: Check STL Rotation üîÑ
        id: check-stls
        run: |
          echo "::group::check-stls"
          chmod +x ${{ github.workspace }}/.github/workflows/check_stl_rotation.py
          for file in $(echo $(find ${{ github.workspace }} -type f -iname '*.STL') | tr '\n' ' '); do
            python3 ${{ github.workspace }}/.github/workflows/check_stl_rotation.py $file || touch failed
          done
          if [ -f "failed" ]; then
            echo "Error occurred while validating STLs."
            exit 255
          fi
          echo "::endgroup::"
  validate_metadata:
    name: Validate metadata files
    runs-on: ubuntu-latest
    needs: [checkout_check_whitespace, setup_python]
    steps:
      - name: Get repository files üß∞
        uses: actions/cache/restore@v3
        id: get-repo-cache
        with:
          path: ${{github.workspace}}
          key: cache-${{github.sha}}
      - name: Setup python 3.11 üêç
        id: python311
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Get python package cache üß∞
        uses: actions/cache@v3
        id: cache-python
        env:
          cache-name: cache-python
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}
      - name: Show tool versions üèÉ
        id: run-tools
        run: |
          echo "Pykwalify $(pykwalify --version)"
      - name: Check Metadata files ‚úÖ
        id: check-metadata
        run: |
          echo "::group::check-metadata"
          for file in $(echo $(find ${{ github.workspace }} -type f -iname '.metadata.yml') | tr '\n' ' '); do
            echo "Checking metadata file $file.."
            pykwalify -d $file -s ${{ github.workspace }}/.workflow_files/yaml_schema.yml
          done
          echo "::endgroup::"
