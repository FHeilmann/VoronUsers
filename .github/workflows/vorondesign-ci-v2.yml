name: VoronUsers CI v2
run-name: VoronUsers CI version 2 ðŸš€
on:
  pull_request:
    types: [opened, reopened, synchronize]
jobs:
  VoronUsers-PR:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Get changed files and check whitespace ðŸ”
        id: changed-files
        uses: FHeilmann/pr-changed-files-check-whitespace@main
      - name: List all changed files ðŸ“ƒ
        run: |
          echo "::group::changed-files"
          for file in ${{ steps.changed-files.outputs.changed_files }}; do
            echo "Changed file: $file"
          done
          echo "::endgroup::"
      - name: Perform Sparse Checkout ðŸ›’
        id: sparse-checkout
        uses: FHeilmann/sparse-checkout@main
        with:
          files: ${{steps.changed-files.outputs.changed_files}}
          folders: ".workflow_files"
          patterns: ""
          path: ${{github.workspace}}
      - name: Install admesh (cached) ðŸ› ï¸
        uses: awalsh128/cache-apt-pkgs-action@v1.3.0
        with:
          packages: admesh, libadmesh-dev
          version: 1.0
      - name: Setup python 3.11 ðŸ
        id: python311
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Handle python package cache ðŸ§°
        uses: actions/cache@v3
        id: cache-python
        env:
          cache-name: cache-python
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}
      - if: ${{ steps.cache-python.outputs.cache-hit != 'true' }}
        name: Install Python packages ðŸ› ï¸
        run: |
          pip install pykwalify admesh git+https://github.com/ChristophSchranz/Tweaker-3.git
      - name: Show tool versions ðŸƒ
        id: run-tools
        run: |
          admesh --version
          echo "Pykwalify $(pykwalify --version)"
          tweaker3 --version
      - name: Find STLs ðŸ”
        uses: jeertmans/filesfinder@v0.4.6
        with:
          args: " --dir ${{github.workspace}} *.STL *.stl"
        id: find-stls
      - name: Check STLs ðŸ“ƒ
        id: check-stls
        run: |
          chmod +x ${{ github.workspace }}/.workflow_files/validate-stl_new.py
          for file in ${{ steps.find-stls.outputs.files }}; do
            python3 ${{ github.workspace }}/.workflow_files/validate-stl_new.py $file || touch failed
          done
          if [ -f "failed" ]; then
            echo "Error occurred while validating STLs."
            exit 255
          fi
      - name: Find Metadata files ðŸ”
        id: find-metadata
        run: |
          FOUND_METADATA=$(echo $(find ${{ github.workspace }} -type f -iname '.metadata.yml') | tr '\n' ' ')
          echo "METADATA=$FOUND_METADATA" >> "$GITHUB_OUTPUT"
      - name: Check Metadata files ðŸ“ƒ
        id: check-metadata
        run: |
          for file in ${{ steps.find-metadata.outputs.METADATA }}; do
            echo "$file found!"
            pykwalify -d $file -s ${{ github.workspace }}/.workflow_files/yaml_schema.yml
          done
        