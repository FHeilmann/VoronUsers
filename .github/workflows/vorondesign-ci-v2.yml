name: VoronUsers CI v2
run-name: "#${{github.event.number}} - ${{github.event.pull_request.title}}"
on:
  pull_request:
    types: [opened, reopened, synchronize]
jobs:
  checkout_check_whitespace:
    permissions:
      pull-requests: read
    name: Checkout & Check Whitespace
    uses: VoronDesign/.github/.github/workflows/pr_checkout_check_whitespace_cache.yml@main
    with:
      branch: ${{ github.ref }}
      cache-key: cache-${{github.sha}}
  setup_python:
    name: Prepare python environment
    uses: VoronDesign/.github/.github/workflows/prepare-environment.yml@main
    with:
      apt-packages: "admesh, libadmesh-dev"
      pip-packages: "pip install pykwalify admesh pyyaml git+https://github.com/ChristophSchranz/Tweaker-3.git"
      python-cache-key: voronusers-python-cache
  check_stls:
    name: Check STL corruption
    needs: [checkout_check_whitespace, setup_python]
    uses: VoronDesign/.github/.github/workflows/check-stl-corruption.yml@main
    with:
      cache-key: cache-${{github.sha}}
      python-cache-key: voronusers-python-cache
  check_stl_rotation:
    name: Check STL rotation
    needs: [checkout_check_whitespace, setup_python]
    uses: VoronDesign/.github/.github/workflows/check-stl-rotation.yml@main
    with:
      cache-key: cache-${{github.sha}}
      python-cache-key: voronusers-python-cache
  validate_metadata:
    name: Check metadata files
    needs: [checkout_check_whitespace, setup_python]
    uses: VoronDesign/.github/.github/workflows/validate-metadata-files.yml@main
    with:
      cache-key: cache-${{github.sha}}
      python-cache-key: voronusers-python-cache
  preview_readme:
    name: Preview README
    needs: [validate_metadata]
    uses: VoronDesign/.github/.github/workflows/generate-readme.yml@main
    with:
      subdirectory: printer_mods
      preview: true
      cache-key: cache-${{github.sha}}
      python-cache-key: voronusers-python-cache


    steps:
      - name: Get repository files ðŸ§°
        uses: actions/cache/restore@v3
        id: get-repo-cache
        with:
          path: ${{github.workspace}}
          key: cache-${{github.sha}}
      - name: Preview README.md
        id: preview-readme
        uses: FHeilmann/voronusers-generate-readme@main
        with:
          target_directory: ${{github.workspace}}/printer_mods
          preview: true
